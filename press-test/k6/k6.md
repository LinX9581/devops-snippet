## 官方文件 指標意義
https://k6.io/docs/using-k6/metrics/

## 其他高QPS參數設置
* mysql
max_connections        = 20000
max_connect_errors = 10000   # 太多連線數or太多error會把該VM IP鎖住
innodb_buffer_pool_size = 4G
innodb_lock_wait_timeout = 50

* nginx
https://cloud.tencent.com/developer/article/1743145
查看目前 net.nf_conntrack_max
sudo sysctl -a | grep conntrack
sudo sysctl -w net.netfilter.nf_conntrack_max=262144
suod sysctl -w net.nf_conntrack_max=262144
sudo sysctl -p //生效
ONNTRACK_MAX = RAMSIZE (in bytes) / 16384 / (ARCH / 32)
記憶體 = 16G
16*1024*1024*1024/16384/後面VM數

* php-fpm
查看單台request
netstat -ant | wc -l
netstat -ant | grep 172.16.2.24:80 | wc -l #從lb過來的話

* linux 內核
https://blog.csdn.net/weixin_42293387/article/details/116051380
error: Cannot assign requested address
每個連線都會占用port 預設60秒才會釋放
sysctl -w net.ipv4.tcp_fin_timeout=15
sysctl -w net.ipv4.tcp_tw_reuse=1     #釋放後會給新的port使用
sysctl -w net.ipv4.tcp_tw_recycle=1

port range
sysctl -a |grep port_range
net.ipv4.ip_local_port_range = 50000    65000
## 參數
指令定義
k6 run hello-k6.js --vus 5 --iterations 15

也可直接寫在JS options
export let options = {
  vus: 10,
  duration: '30s',
};

## 測試型別
Smoke Testing   -> 盡可能用最少的資源去測試，只是為了測試出有沒有 error
Load testing    -> 主要是關注當前系統的配置，在多少 user 或 RPS 時，performance 是如何
Stress Testing  -> 測試系統的極限
Spike Testing   -> 測試 短時間大量流量
Soak Testing    -> 測試長時間的系統穩定

## install
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

mkdir k6
cd k6
hello-k6.js

import http from 'k6/http';
import { sleep } from 'k6';

export default function () {
  http.get('https://test.k6.io');
  sleep(1);
}

k6 run hello-k6.js


# 測試結果
以下都是1台LB 4台VM

4c8g
30s 500  (O 
30s 1500 (X
30m long time concurrent 5000 cpu overloading

4c16g
30s 1500 (O
30s 2500 (X
30m long time concurrent 5000 cpu overloading

8c32g *4
30s 1500 (O
30s 2500 (O
30s 3500 (O
30s 4500 (O
30s 5500 (O
30m long time concurrent 5000 少部分 request fail 1.9%

16c64g * 1
30s 6000 (O) fail 8%  avg 5.62 p90 11.64s
30s 4000 (O) fail 10% avg 3.2  p95 8.49s
30s 3000 (O) fail 0.8% avg 3.13  p95 6~8.11s
30s 2000 (O) fail 0.0% avg 1.59  p95 4.83s
30s 1500 (O) fail 0.0% avg 1.05  p95 2.54s
30s 1000 1s內
# 8C32G * 5

30秒  3500
50m   4500
95%的人平均loading 2秒
0.99% fail

30S 5000 
30s/+200 -> 5800
95% 3秒內
fail 1.31%

30s 6000
30s/+200 -> 6800
95% 3.03S
3.49% fail

30s 7000
30s/+200 -> 7800
95% 4.13s
16.14% fail

# 8C32G * 9
30S, 5000,  fail 0.2%  ,AVG 1.9S , P95 4.9S
30S, 5000,  fail 0.09% ,AVG 3.13S, P95 15.49
30S, 5000,  fail 0.02% ,AVG 1.01S, P95 2.29
30S, 5000,  fail 0.17% ,AVG 0.86S, P90 1.82 P95 2.87
30S, 7000,  fail 0.27% ,AVG 1.37S, P95 7.13
30S, 7000,  fail 0.25% ,AVG 1.37S, P95 4.94
30S, 8500,  fail 0.00% ,AVG 1.33S, P90 3.53 P95 7.2
30S, 9500,  fail 0.00% ,AVG 1.66S, P90 3.71 P95 7.69
30S, 10000, fail 0.00% ,AVG 1.78S, P90 3.85 P95 7.79
30S, 10000, fail 1.67% ,AVG 5.04S, P90 16.13 P95 31.03
60S, 10000, fail 1.33% ,AVG 3.44S, P90 8.19 P95 16.42
30S, 11000, fail 0.00% ,AVG 1.97S, P90 5.61 P95 7.81
60S, 11000, fail 0.08% ,AVG 1.88S, P90 3.72 P95 7.75
* 這邊資料庫設了 max_connect_errors = 10000 (避免mysql誤鎖連線過多的VM)
30S, 12000, fail 0.00% ,AVG 0.70S, P90 1.36 P95 2.78
30S, 13000, fail 0.00% ,AVG 1.45S, P90 4.57 P95 7.31
3 M, 11000, fail 5.80% ,AVG 0.74S, P90 1.93 P95 2.93
3 M, 13000, fail 13.2% ,AVG 0.94S, P90 2.23 P95 2.74
10M, 10000, fail 26.7% ,AVG 1.05S, P90 2.39 P95 3.27
* fpm -> 4000
同上
* 更改 tcp_fin_timeout = 15 , reuse = 1
10M, 12000, fail 29.65% ,AVG 1.63S, P90 3.22 P95 4.76
 

# Gcp Lb 8C32G * 9 fpm 4000
30S, 13000, fail 0.00% ,AVG 1.17S, P90 3.30 P95 4.2
30S, 15000, fail 6.11% ,AVG 2.77S, P90 3.53 P95 30
10M, 12000, fail 32.54% ,AVG 1.06S, P90 2.26 P95 3.03
# Gcp Lb 8C32G * 15 fpm 4000
30S, 13000, fail 4.99% ,AVG 1.77S, P90 3.87 P95 7.28
10M, 12000, fail 20.87% ,AVG 1.37S, P90 4.57 P95 6.76

